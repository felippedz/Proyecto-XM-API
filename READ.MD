# Manual de Uso: Sistema de Consulta y Almacenamiento de MÃ©tricas XM

---

## ğŸ“‚ DescripciÃ³n General

Este sistema permite generar payloads a partir de un archivo Excel, realizar consultas a la API pÃºblica de XM, almacenar las respuestas en formato JSON organizadas por mÃ©tricas y fechas, y finalmente insertar los resultados en una base de datos relacional MariaDB.

---

## ğŸ“ Estructura del Proyecto

```
tu_proyecto/
â”‚
â”œâ”€â”€ datos/
â”‚   â””â”€â”€ datos_API (1).xlsx          â† Archivo Excel con mÃ©tricas
â”‚
â”œâ”€â”€ respuestas_json/                â† Se crean automÃ¡ticamente al generar payloads y respuestas
â”‚   â””â”€â”€ {MetricId}_{Entity}/
â”‚       â””â”€â”€ {StartDate}_{EndDate}/
â”‚           â””â”€â”€ response.json       â† Respuesta de la API
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generar_payloads.py         â† Genera payloads a partir del Excel
â”‚   â”œâ”€â”€ consultar_api.py            â† Consulta la API con los payloads JSON
â”‚   â””â”€â”€ insertar_mariadb.py         â† Inserta datos procesados en la base de datos
â”‚
â”œâ”€â”€ .env / config.py (opcional)     â† Credenciales si deseas separar configuraciÃ³n
â””â”€â”€ README.md                       â† Manual de uso
```

---

## ğŸ“‹ Requisitos

- Python 3.9 o superior
- MariaDB (o MySQL compatible)
- Paquetes Python:
  ```bash
  pip install pandas openpyxl requests mysql-connector-python
  ```

---

## âš™ï¸ ConfiguraciÃ³n de la Base de Datos

Crea la base de datos y tabla `metric_results` con esta estructura:

```sql
CREATE DATABASE xm_data;

USE xm_data;

CREATE TABLE metric_results (
    id INT AUTO_INCREMENT PRIMARY KEY,
    MetricId VARCHAR(100),
    Entity VARCHAR(100),
    StartDate DATE,
    EndDate DATE,
    Result JSON,
    UNIQUE KEY uniq_metric (MetricId, Entity, StartDate, EndDate)
);
```

Configura el acceso a la base de datos en `insertar_mariadb.py`:

```python
db_config = {
    "host": "localhost",
    "port": 3307,
    "user": "xm_user",
    "password": "xm_password",
    "database": "xm_data",
    "ssl_disabled": True
}
```

---

## ğŸš€ EjecuciÃ³n del Programa

### 1. Generar Payloads desde el archivo Excel

```bash
cd scripts/
python generar_payloads.py
```

- Crea archivos `.json` en la carpeta `respuestas_json/`, organizados por mÃ©trica y entidad.

---

### 2. Realizar consultas a la API usando los payloads

```bash
python consultar_api.py
```

- Realiza POSTs a la API usando los payloads generados.
- Guarda cada respuesta como `response.json` en subcarpetas por fecha.
- LÃ­mite predeterminado: 50 consultas (modificable en el script).

---

### 3. Insertar datos en la base de datos MariaDB

```bash
python insertar_mariadb.py
```

- Lee cada archivo `response.json`.
- Inserta el contenido como JSON en `metric_results` si no existe previamente.

---

## ğŸ“Œ Observaciones

- Los JSON de entrada deben tener la clave `"Url"` para que `consultar_api.py` funcione.
- Las respuestas deben seguir el formato que contenga `MetricId`, `Entity`, `StartDate`, `EndDate` y `Items`.
- Si deseas hacer anÃ¡lisis mÃ¡s profundos, puedes normalizar los datos en tablas adicionales (`metric_values`, por ejemplo).
- Los scripts imprimen en consola el estado de la ejecuciÃ³n para facilitar el seguimiento.
